import tkinter as tk
from tkinter import messagebox
import bcrypt
import pyodbc
from sqldb_conn import create_connection, close_connection


def registrar_usuario():
    usuario = entry_usuario.get().strip()
    nombre = entry_nombre.get().strip()
    apellido = entry_apellido.get().strip()
    correo = entry_correo.get().strip()
    telefono = entry_telefono.get().strip()
    password_plana = entry_contrase√±a.get().strip()
    password_confirm = entry_confirmar.get().strip()

    # Validaciones b√°sicas
    if not usuario or not correo or not password_plana:
        messagebox.showwarning("Campos obligatorios", "Usuario, correo y contrase√±a no pueden estar vac√≠os.")
        return
    if password_plana != password_confirm:
        messagebox.showerror("Error", "Las contrase√±as no coinciden.")
        return

    try:
        conn = create_connection()
        cursor = conn.cursor()

        # Hasheo de contrase√±a
        salt = bcrypt.gensalt()
        password_hashed = bcrypt.hashpw(password_plana.encode('utf-8'), salt)

        # Inserci√≥n
        query = """
        INSERT INTO Usuario (Usuario, Nombre, Apellido, Contrase√±a, Correo, Telefono)
        VALUES (?, ?, ?, ?, ?, ?)
        """
        values = (usuario, nombre, apellido, password_hashed.decode('utf-8'), correo, telefono)
        cursor.execute(query, values)
        conn.commit()

        messagebox.showinfo("√âxito", f"‚úÖ ¬°Usuario '{usuario}' registrado exitosamente!")
        limpiar_campos()

    except pyodbc.IntegrityError as e:
        if 'UNIQUE KEY' in str(e):
            messagebox.showerror("Error", "El nombre de usuario o correo electr√≥nico ya existen.")
        else:
            messagebox.showerror("Error de integridad", f"Ocurri√≥ un error: {e}")
    except Exception as e:
        messagebox.showerror("Error inesperado", f"Ocurri√≥ un error: {e}")
    finally:
        close_connection(conn)


def limpiar_campos():
    entry_usuario.delete(0, tk.END)
    entry_nombre.delete(0, tk.END)
    entry_apellido.delete(0, tk.END)
    entry_correo.delete(0, tk.END)
    entry_telefono.delete(0, tk.END)
    entry_contrase√±a.delete(0, tk.END)
    entry_confirmar.delete(0, tk.END)


# ====== Interfaz gr√°fica ======

ventana = tk.Tk()
ventana.title("Registro de usuario")
ventana.geometry("500x500")
ventana.config(bg="#f5f7fb")
ventana.resizable(False, False)

titulo = tk.Label(
    ventana, text="üìù Registro de nuevo usuario",
    font=("Segoe UI", 18, "bold"), bg="#f5f7fb", fg="#2f4f4f"
)
titulo.pack(pady=20)

frame = tk.Frame(ventana, bg="#f5f7fb")
frame.pack(pady=10)

labels = ["Usuario:", "Nombre:", "Apellido:", "Correo:", "Tel√©fono:", "Contrase√±a:", "Confirmar contrase√±a:"]
entries = []

for i, text in enumerate(labels):
    tk.Label(frame, text=text, bg="#f5f7fb", font=("Segoe UI", 11)).grid(row=i, column=0, sticky="e", padx=5, pady=5)
    entry = tk.Entry(frame, width=30, font=("Segoe UI", 10), show="*" if "Contrase√±a" and "Confirmar" in text else "")
    entry.grid(row=i, column=1, padx=5, pady=5)
    entries.append(entry)

entry_usuario, entry_nombre, entry_apellido, entry_correo, entry_telefono, entry_contrase√±a, entry_confirmar = entries

# Bot√≥n registrar
btn_registrar = tk.Button(
    ventana,
    text="Registrar usuario",
    bg="#28A745", fg="white",
    font=("Segoe UI", 11, "bold"),
    relief="flat",
    padx=10, pady=6,
    command=registrar_usuario
)
btn_registrar.pack(pady=20)

ventana.mainloop()
